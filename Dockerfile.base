# Claude Code Sandbox Base Image
# Foundation with security settings, Unix toolchain, and development utilities
FROM docker/sandbox-templates:claude-code

# Set environment variables
ENV CLAUDE_SANDBOX_MODE=enabled \
    CLAUDE_AUTO_ALLOW_SANDBOXED=true \
    DEBIAN_FRONTEND=noninteractive \
    TERM=xterm-256color

# Repo for recent github cli, see official docs at:
# https://github.com/cli/cli/blob/trunk/docs/install_linux.md#debian
# the one packaged in the ubuntu repos is 2 years old
RUN mkdir -p -m 755 /etc/apt/keyrings && \
    out=$(mktemp) && wget -nv -O$out https://cli.github.com/packages/githubcli-archive-keyring.gpg && \
    cat $out | tee /etc/apt/keyrings/githubcli-archive-keyring.gpg > /dev/null && \
    chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg && \
    mkdir -p -m 755 /etc/apt/sources.list.d && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null

# Install system packages and development tools in a single layer
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential gfortran binutils \
    autoconf automake m4 bison flex gdb libtool linux-headers-generic \
    git subversion bzr mercurial cvs gh git-lfs git-delta \
    bzip2 gzip zip unzip zlib1g zlib1g-dev libssl-dev \
    jq pkg-config cmake shellcheck shfmt exuberant-ctags \
    less tree dos2unix uni2ascii pv rlwrap locate members diffutils \
    ripgrep fd-find bat fzf \
    bubblewrap \
    \
    vim nano \
    \
    unixodbc unixodbc-dev sqlite3 mysql-client postgresql-client libpq-dev \
    pgtop odbc-postgresql \
    \
    ca-certificates locales tzdata wamerican \
    curl wget gnupg gnupg-agent apt-transport-https apt-utils \
    software-properties-common \
    \
    libopenblas-dev liblapack-dev libomp-dev libgsl-dev libarpack2-dev \
    \
    gnuplot ffmpeg imagemagick pandoc \
    \
    && apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Set locale
RUN locale-gen en_US.UTF-8
ENV LANG=en_US.UTF-8 \
    LANGUAGE=en_US:en \
    LC_ALL=en_US.UTF-8

# Create agent user and directories
RUN useradd -m -s /bin/bash agent && \
    mkdir -p /home/agent/.claude/hooks /home/agent/.claude/logs /etc/claude-code && \
    chown -R agent:agent /home/agent/.claude

# Copy Claude Code configuration files
COPY --chown=root:root managed-settings.json /etc/claude-code/managed-settings.json
COPY --chown=agent:agent settings.json /home/agent/.claude/settings.json
COPY --chown=agent:agent hooks/pre-command-validator.sh /home/agent/.claude/hooks/pre-command-validator.sh
COPY --chown=agent:agent hooks/post-command-logger.sh /home/agent/.claude/hooks/post-command-logger.sh

# Make hooks executable
RUN chmod +x /home/agent/.claude/hooks/*.sh

# Copy user guide
COPY SANDBOX-README.md /home/agent/README.md

# Configure git for agent user
RUN git config --system core.pager "delta" && \
    git config --system interactive.diffFilter "delta --color-only" && \
    git config --system delta.navigate true && \
    git config --system delta.side-by-side true && \
    git config --system merge.conflictstyle diff3 && \
    git config --system diff.colorMoved default

# Create workspace directory
RUN mkdir -p /workspace && chown agent:agent /workspace

# Switch to agent user
USER agent
WORKDIR /workspace

# Default command
CMD ["/bin/bash"]
